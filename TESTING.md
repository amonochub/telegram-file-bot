# Руководство по тестированию Telegram File Bot

## Обзор

Этот документ описывает комплексную систему тестирования проекта, включающую ручные и автоматические тесты.

## Типы тестов

### 1. Ручные тесты
- **Назначение**: Проверка функциональности в реальных условиях
- **Файлы**: `tests/manual_test_guide.md`, `scripts/manual_test_runner.py`
- **Запуск**: `make test-manual` или `python scripts/manual_test_runner.py`

### 2. Модульные тесты
- **Назначение**: Тестирование отдельных функций и классов
- **Файлы**: `tests/test_*.py`
- **Запуск**: `make test-unit` или `pytest tests/ -v`

### 3. Интеграционные тесты
- **Назначение**: Тестирование взаимодействия между компонентами
- **Файлы**: `tests/test_integration.py`
- **Запуск**: `make test-integration`

### 4. Тесты производительности
- **Назначение**: Проверка скорости и эффективности работы
- **Файлы**: `tests/test_performance.py`
- **Запуск**: `make test-performance`

### 5. Тесты безопасности
- **Назначение**: Проверка уязвимостей и защиты
- **Файлы**: `tests/test_security.py`
- **Запуск**: `make test-security`

## Быстрый старт

### 1. Установка зависимостей
```bash
# Установка основных зависимостей
pip install -r requirements.txt

# Установка зависимостей для разработки
pip install -r requirements.dev.txt
```

### 2. Настройка окружения
```bash
# Создание необходимых директорий
make setup

# Проверка переменных окружения
make check-env
```

### 3. Запуск всех тестов
```bash
# Все автоматические тесты
make test

# Все тесты (включая ручные)
make test-all

# Быстрые тесты
make test-quick
```

## Детальное описание

### Ручные тесты

Ручные тесты проверяют функциональность в реальных условиях:

```bash
# Запуск ручных тестов
make test-manual

# Или напрямую
python scripts/manual_test_runner.py
```

**Что проверяется:**
- Запуск и инициализация бота
- Подключение к внешним сервисам
- Загрузка и обработка файлов
- Навигация по меню
- Курсы валют и калькулятор
- Интеграция с Яндекс.Диском

### Модульные тесты

Модульные тесты проверяют отдельные функции:

```bash
# Запуск всех модульных тестов
make test-unit

# Запуск конкретного теста
pytest tests/test_cbr_rate_service.py -v

# Запуск с покрытием
make test-coverage
```

**Примеры тестов:**
- `test_cbr_rate_service.py` - тесты сервиса курсов валют
- `test_rates_cache.py` - тесты кэширования
- `test_file_validation.py` - тесты валидации файлов

### Интеграционные тесты

Интеграционные тесты проверяют взаимодействие компонентов:

```bash
# Запуск интеграционных тестов
make test-integration

# Или напрямую
pytest tests/test_integration.py -v
```

**Что проверяется:**
- Взаимодействие между сервисами
- Обработка ошибок
- Конкурентные операции
- Консистентность данных

### Тесты производительности

Тесты производительности проверяют скорость работы:

```bash
# Запуск тестов производительности
make test-performance

# Или напрямую
pytest tests/test_performance.py -v
```

**Что измеряется:**
- Скорость кэширования
- Время отклика API
- Использование памяти
- Пропускная способность

### Тесты безопасности

Тесты безопасности проверяют защиту от уязвимостей:

```bash
# Запуск тестов безопасности
make test-security

# Или напрямую
pytest tests/test_security.py -v
```

**Что проверяется:**
- Валидация файлов
- Защита от path traversal
- Контроль доступа
- Безопасность токенов

## Дополнительные инструменты

### Линтинг
```bash
# Запуск линтера
make lint

# Или напрямую
flake8 app/ tests/ --max-line-length=120
```

### Проверка типов
```bash
# Запуск проверки типов
make types

# Или напрямую
mypy app/ --ignore-missing-imports
```

### Форматирование кода
```bash
# Форматирование кода
make format

# Или напрямую
black app/ tests/ --line-length=120
isort app/ tests/
```

### Проверка безопасности
```bash
# Проверка безопасности
make security-check

# Или напрямую
bandit -r app/ -f json -o security_report.json
```

## Отчеты

### Генерация отчетов
```bash
# Генерация полного отчета
make test-report

# Или напрямую
python scripts/run_all_tests.py --all
```

### Просмотр отчетов
- **HTML отчет о покрытии**: `htmlcov/index.html`
- **JSON отчет о тестировании**: `logs/comprehensive_test_report.json`
- **Логи тестирования**: `logs/test_runner.log`

## CI/CD

### Настройка для CI/CD
```bash
# Запуск тестов для CI/CD
make ci
```

Этот набор команд включает:
- Настройку окружения
- Проверку переменных окружения
- Модульные тесты
- Интеграционные тесты
- Тесты безопасности
- Линтинг
- Проверку типов

### Для разработки
```bash
# Быстрые тесты для разработки
make dev
```

## Структура тестов

```
tests/
├── conftest.py              # Конфигурация pytest
├── test_*.py                # Модульные тесты
├── test_integration.py      # Интеграционные тесты
├── test_performance.py      # Тесты производительности
├── test_security.py         # Тесты безопасности
└── manual_test_guide.md     # Руководство по ручному тестированию

scripts/
├── manual_test_runner.py    # Автоматизация ручных тестов
└── run_all_tests.py        # Запуск всех тестов

logs/
├── test_runner.log         # Логи тестирования
├── manual_test.log         # Логи ручных тестов
└── comprehensive_test_report.json  # Отчет о тестировании
```

## Маркеры pytest

Используются следующие маркеры:

- `@pytest.mark.asyncio` - асинхронные тесты
- `@pytest.mark.slow` - медленные тесты
- `@pytest.mark.integration` - интеграционные тесты
- `@pytest.mark.unit` - модульные тесты

## Переменные окружения для тестирования

Создайте файл `.env` на основе `env.example`:

```bash
# Обязательные
BOT_TOKEN=your_bot_token_here

# Опциональные
YANDEX_DISK_TOKEN=your_yandex_token_here
GEMINI_API_KEY=your_gemini_key_here
ALLOWED_USER_ID=123456789

# Настройки
LOG_LEVEL=INFO
MAX_FILE_SIZE=100000000
CACHE_TTL=3600
```

## Устранение неполадок

### Проблемы с зависимостями
```bash
# Очистка и переустановка
make clean
pip install -r requirements.txt
pip install -r requirements.dev.txt
```

### Проблемы с тестами
```bash
# Запуск с подробным выводом
pytest tests/ -v -s

# Запуск конкретного теста
pytest tests/test_cbr_rate_service.py::TestCBRRateService::test_get_current_rates -v
```

### Проблемы с покрытием
```bash
# Генерация HTML отчета
pytest tests/ --cov=app --cov-report=html
# Откройте htmlcov/index.html в браузере
```

## Рекомендации

### Для разработчиков
1. Запускайте `make dev` перед коммитом
2. Используйте `make test-quick` для быстрой проверки
3. Проверяйте покрытие кода регулярно

### Для тестировщиков
1. Используйте `tests/manual_test_guide.md` как чек-лист
2. Запускайте `make test-manual` для автоматизации
3. Проверяйте отчеты в `logs/`

### Для DevOps
1. Используйте `make ci` в CI/CD пайплайнах
2. Настройте уведомления о проваленных тестах
3. Мониторьте производительность регулярно

## Контакты

При возникновении проблем с тестированием:
1. Проверьте логи в `logs/`
2. Убедитесь, что все зависимости установлены
3. Проверьте переменные окружения
4. Создайте issue с подробным описанием проблемы 