# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. üê≥ –£–ª—É—á—à–µ–Ω–Ω–∞—è Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –°–æ–∑–¥–∞–Ω `docker-compose.production.yml`
- ‚úÖ –£–±—Ä–∞–Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è `version: '3.8'`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã health checks –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU/Memory)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç—å
- ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å condition: service_healthy

#### –°–æ–∑–¥–∞–Ω `Dockerfile.production`
- ‚úÖ Multi-stage build –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
- ‚úÖ –ù–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (botuser)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
- ‚úÖ Health check –≤—Å—Ç—Ä–æ–µ–Ω –≤ –æ–±—Ä–∞–∑
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ layers

### 2. üè• Health Check —Å–∏—Å—Ç–µ–º–∞

#### –°–æ–∑–¥–∞–Ω `app/health.py`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¶–ë –†–§ API
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ Yandex.Disk API
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ JSON API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 3. üîí –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis

#### –°–æ–∑–¥–∞–Ω `redis.conf`
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –õ–∏–º–∏—Ç—ã –ø–∞–º—è—Ç–∏ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è

### 4. üöÄ –£–ª—É—á—à–µ–Ω–Ω—ã–π deployment

#### –°–æ–∑–¥–∞–Ω `deploy_production.sh`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ backup'–æ–≤
- ‚úÖ Health checks –ø–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
- ‚úÖ Rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –¢–∞–π–º–∞—É—Ç—ã –∏ retry –ª–æ–≥–∏–∫–∞

### 5. üåç Environment –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

#### –°–æ–∑–¥–∞–Ω `.env.production`
- ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh user@your-server.com

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/telegram-file-bot

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
git pull origin main
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ environment

```bash
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp .env.production .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
nano .env

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
chmod 600 .env
```

### –®–∞–≥ 3: Production –¥–µ–ø–ª–æ–π

```bash
# –ó–∞–ø—É—Å–∫ production –¥–µ–ø–ª–æ—è
./deploy_production.sh -f docker-compose.production.yml

# –ò–ª–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏
./deploy_production.sh -f docker-compose.production.yml -t 180
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose -f docker-compose.production.yml ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker-compose -f docker-compose.production.yml logs -f bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ health checks
docker-compose -f docker-compose.production.yml exec bot python -c "from app.health import simple_health_check; import asyncio; print('Health:', asyncio.run(simple_health_check()))"
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker-compose -f docker-compose.production.yml logs

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker-compose -f docker-compose.production.yml config

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
docker system df
docker stats
```

### –ü—Ä–æ–±–ª–µ–º–∞: Health checks –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç

```bash
# –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ health check
docker-compose -f docker-compose.production.yml exec bot python -c "
import asyncio
from app.health import health_checker
async def test():
    await health_checker.start()
    result = await health_checker.comprehensive_health_check()
    print(result)
    await health_checker.stop()
asyncio.run(test())
"
```

### –ü—Ä–æ–±–ª–µ–º–∞: Redis –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
docker-compose -f docker-compose.production.yml exec redis redis-cli ping

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Redis
docker-compose -f docker-compose.production.yml logs redis

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Redis
docker-compose -f docker-compose.production.yml exec redis cat /usr/local/etc/redis/redis.conf
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Redis –ø–∞—Ä–æ–ª—è**:
```bash
# –í redis.conf —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:
# requirepass your_secure_password_here

# –í .env –¥–æ–±–∞–≤–∏—Ç—å:
REDIS_URL=redis://:your_password@redis:6379
```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall**:
```bash
# –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ—Ä—Ç—ã
sudo ufw allow ssh
sudo ufw allow 443
sudo ufw deny 6379  # Redis —Ç–æ–ª—å–∫–æ –¥–ª—è Docker —Å–µ—Ç–∏
sudo ufw enable
```

3. **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**:
```bash
# –°–æ–∑–¥–∞—Ç—å cron job –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤
0 2 * * 0 cd /path/to/bot && ./deploy_production.sh --no-backup
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker-compose -f docker-compose.production.yml logs -f --tail=100

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
docker-compose -f docker-compose.production.yml logs | grep -i "error\|exception"

# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
docker stats $(docker-compose -f docker-compose.production.yml ps -q)
```

### Health check –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
cat > monitor_health.sh << 'EOF'
#!/bin/bash
HEALTH=$(docker-compose -f docker-compose.production.yml exec -T bot python -c "
from app.health import simple_health_check
import asyncio
print(asyncio.run(simple_health_check()))
" 2>/dev/null)

if [ "$HEALTH" != "True" ]; then
    echo "ALERT: Bot health check failed!"
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
fi
EOF

chmod +x monitor_health.sh

# –î–æ–±–∞–≤–∏—Ç—å –≤ cron –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
# */5 * * * * /path/to/monitor_health.sh
```

## üîÑ Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback

```bash
# Rollback –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
./deploy_production.sh --rollback $(ls -t backups/ | head -1 | cut -d'_' -f1-2)
```

### –†—É—á–Ω–æ–π rollback

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose -f docker-compose.production.yml down

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
git reset --hard HEAD~1

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker-compose -f docker-compose.production.yml up -d
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

- [ ] `.env` —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- [ ] `redis.conf` –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø–∞—Ä–æ–ª–µ–º
- [ ] Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Health checks —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] SSL/TLS –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: Health checks –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback  
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ù–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∏–∑–æ–ª—è—Ü–∏—è  
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑  
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–µ—Ç–∞–ª—å–Ω—ã–µ health checks –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π deployment —Å backup'–∞–º–∏  

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ! üöÄ
